From b480f3590f2fc26763f0a78b42823f50c8ce41fb Mon Sep 17 00:00:00 2001
From: Pavel Odintsov <pavel.odintsov@gmail.com>
Date: Thu, 27 Jul 2017 23:19:33 +0100
Subject: [PATCH 1/2] Introduced an option to disable Netmap plugin

---
 src/CMakeLists.txt    | 41 ++++++++++++++++++++++++++++++++---------
 src/fastnetmon.cpp    |  5 +++++
 src/plugin_runner.cpp |  2 ++
 3 files changed, 39 insertions(+), 9 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index e8126b1..4f56f3f 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -97,7 +97,7 @@ execute_process(COMMAND git rev-list HEAD COMMAND head -n 1 OUTPUT_VARIABLE GIT_
 set(FASTNETMON_APPLICATION_VERSION "1.1.3 master git-${GIT_LAST_COMMIT_HASH}")
 configure_file(fast_platform.h.template "${PROJECT_SOURCE_DIR}/fast_platform.h")
 
-# With this flag we can diable PF_RING build via console: cmake .. -DDISABLE_PF_RING_SUPPORT=ON
+# With this flag we can disable PF_RING build via console: cmake .. -DDISABLE_PF_RING_SUPPORT=ON
 if (NOT DISABLE_PF_RING_SUPPORT) 
     if (${CMAKE_SYSTEM_NAME} STREQUAL "Linux")
         message(STATUS "You are running Linux and we can build PF_RING support")
@@ -107,6 +107,16 @@ if (NOT DISABLE_PF_RING_SUPPORT)
     endif() 
 endif()
 
+# With this flag we could disable Netmap build this way: cmake .. -DDISABLE_NETMAP_SUPPORT=ON
+if (NOT DISABLE_NETMAP_SUPPORT)
+    set (ENABLE_NETMAP_SUPPORT ON)
+endif()
+
+if (ENABLE_NETMAP_SUPPORT)
+    message(STATUS "We will build Netmap support for you")
+    add_definitions(-DNETMAP_PLUGIN)
+endif()
+
 if (ENABLE_PFRING_SUPPORT)
     # Set path to manually compiled PF_RING
     set(PFRING_INCLUDE_DIRS "${PFRING_CUSTOM_INSTALL_PATH}/include")
@@ -363,11 +373,13 @@ endif()
 # example plugin
 add_library(example_plugin STATIC example_plugin/example_collector.cpp)
 
-# Netmap plugin
-set(NETMAP_INCLUDE_DIRS "netmap_plugin/netmap_includes")
-include_directories(${NETMAP_INCLUDE_DIRS})
-add_library(netmap_plugin STATIC netmap_plugin/netmap_collector.cpp)
-target_link_libraries(netmap_plugin fastnetmon_packet_parser)
+if (ENABLE_NETMAP_SUPPORT)
+    # Netmap plugin
+    set(NETMAP_INCLUDE_DIRS "netmap_plugin/netmap_includes")
+    include_directories(${NETMAP_INCLUDE_DIRS})
+    add_library(netmap_plugin STATIC netmap_plugin/netmap_collector.cpp)
+    target_link_libraries(netmap_plugin fastnetmon_packet_parser)
+endif()
 
 # Client tool
 add_executable(fastnetmon_client fastnetmon_client.cpp)
@@ -518,7 +530,11 @@ if (ENABLE_AFPACKET_SUPPORT)
     target_link_libraries(fastnetmon afpacket_plugin)
 endif()
 
-target_link_libraries(fastnetmon sflow_plugin netflow_plugin pcap_plugin example_plugin netmap_plugin)
+target_link_libraries(fastnetmon sflow_plugin netflow_plugin pcap_plugin example_plugin)
+
+if (ENABLE_NETMAP_SUPPORT)
+    target_link_libraries(fastnetmon netmap_plugin)
+endif()
 
 # cmake .. -DBUILD_PLUGIN_RUNNER=ON
 if (BUILD_PLUGIN_RUNNER)
@@ -539,7 +555,11 @@ if (BUILD_PLUGIN_RUNNER)
     target_link_libraries(fastnetmon_plugin_runner fast_library)
 
     # Add all plugins
-    target_link_libraries(fastnetmon_plugin_runner sflow_plugin netflow_plugin pcap_plugin example_plugin netmap_plugin)
+    target_link_libraries(fastnetmon_plugin_runner sflow_plugin netflow_plugin pcap_plugin example_plugin)
+
+    if (ENABLE_NETMAP_SUPPORT)
+        target_link_libraries(fastnetmon_plugin_runner netmap_plugin)
+    endif()
 
     if (ENABLE_PFRING_SUPPORT)
         target_link_libraries(fastnetmon_plugin_runner ${PFRING_LIBRARIES})
@@ -559,7 +579,10 @@ if (BUILD_PCAP_READER)
     target_link_libraries(fastnetmon_pcap_reader ${LOG4CPP_LIBRARY_PATH})
     target_link_libraries(fastnetmon_pcap_reader netflow_plugin)   
     target_link_libraries(fastnetmon_pcap_reader sflow_plugin)
-    target_link_libraries(fastnetmon_pcap_reader netmap_plugin)
+
+    if (ENABLE_NETMAP_SUPPORT)
+        target_link_libraries(fastnetmon_pcap_reader netmap_plugin)
+    endif()
 
     if (ENABLE_DPI_SUPPORT)
         target_link_libraries(fastnetmon_pcap_reader fast_dpi)
diff --git a/src/fastnetmon.cpp b/src/fastnetmon.cpp
index d3bb12f..c1a43da 100644
--- a/src/fastnetmon.cpp
+++ b/src/fastnetmon.cpp
@@ -45,7 +45,10 @@
 #include "sflow_plugin/sflow_collector.h"
 #include "netflow_plugin/netflow_collector.h"
 #include "pcap_plugin/pcap_collector.h"
+
+#ifdef NETMAP_PLUGIN
 #include "netmap_plugin/netmap_collector.h"
+#endif
 
 #ifdef PF_RING
 #include "pfring_plugin/pfring_collector.h"
@@ -2812,10 +2815,12 @@ int main(int argc, char** argv) {
     }
 #endif
 
+#ifdef NETMAP_PLUGIN
     // netmap processing
     if (enable_netmap_collection) {
         packet_capture_plugin_thread_group.add_thread(new boost::thread(start_netmap_collection, process_packet));
     }
+#endif
 
 #ifdef SNABB_SWITCH 
     if (enable_snabbswitch_collection) {
diff --git a/src/plugin_runner.cpp b/src/plugin_runner.cpp
index 43005c6..b550689 100644
--- a/src/plugin_runner.cpp
+++ b/src/plugin_runner.cpp
@@ -29,7 +29,9 @@
 #include "snabbswitch_plugin/snabbswitch_collector.h"
 #endif
 
+#ifdef NETMAP_PLUGIN
 #include "netmap_plugin/netmap_collector.h"
+#endif
 
 // log4cpp logging facility
 #include "log4cpp/Category.hh"
-- 
2.11.0

